CREATE SCHEMA IF NOT EXISTS tr;

SET
    search_path TO tr;

CREATE TABLE roles
(
    id   BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT NOT NULL
);

CREATE TABLE users
(
    id         BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    first_name VARCHAR(50)                                        NOT NULL,
    last_name  VARCHAR(50)                                        NOT NULL,
    email      TEXT                                               NOT NULL,
    password   VARCHAR(255)                                       NOT NULL,
    role       BIGINT                                             NOT NULL REFERENCES roles (id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE UNIQUE INDEX uq_users_email_ci ON users (lower(email));

CREATE TYPE account_type AS ENUM ('CASH','CARD','BANK');

CREATE TABLE accounts
(
    id         BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id    BIGINT                    NOT NULL references users (id),
    name       TEXT                      NOT NULL,
    type       account_type              NOT NULL,
    currency   CHAR(3)     DEFAULT 'EUR' NOT NULL,
    archived   BOOL        DEFAULT false NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

CREATE INDEX idx_accounts_user_id ON accounts (user_id);

CREATE TABLE categories
(
    id         BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    user_id    BIGINT      NOT NULL REFERENCES users (id),
    parent_id  BIGINT REFERENCES categories (id),
    name       TEXT        NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 1. Enforce uniqueness for top-level categories (Where parent_id IS NULL)
CREATE UNIQUE INDEX uq_categories_top_level_name
    ON categories (user_id, LOWER(name)) WHERE parent_id IS NULL;

-- 2. Enforce uniqueness for sub-categories (Where a parent exists)
CREATE UNIQUE INDEX uq_categories_sub_name
    ON categories (user_id, parent_id, LOWER(name)) WHERE parent_id IS NOT NULL;

-- 3. General performance index for lookups by user
CREATE INDEX idx_categories_user_id
    ON categories (user_id);

CREATE TABLE transactions
(
    id          BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    user_id     BIGINT         NOT NULL REFERENCES users (id),
    account_id  BIGINT         NOT NULL REFERENCES accounts (id),
    category_id BIGINT         NOT NULL REFERENCES categories (id),
    amount      NUMERIC(14, 2) NOT NULL,
    currency    CHAR(3)        NOT NULL,
    description TEXT,
    external_id TEXT,
    occurred_at TIMESTAMPTZ    NOT NULL,
    created_at  TIMESTAMPTZ    NOT NULL DEFAULT now(),
    updated_ay  TIMESTAMPTZ    NOT NULL DEFAULT now()
);

CREATE INDEX idx_tx_user_occurred
    ON transactions (user_id, occurred_at DESC);

CREATE INDEX idx_tx_account_occurred
    ON transactions (account_id, occurred_at DESC);

CREATE TABLE budgets
(
    id             BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    user_id        BIGINT      NOT NULL REFERENCES users (id),
    category_id    BIGINT      NOT NULL REFERENCES categories (id),
    name           TEXT        NOT NULL,
    month          DATE        NOT NULL,
    planned_amount NUMERIC(14, 2),
    created_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX uq_budget_user_month_category
    ON budgets (user_id, month, category_id)